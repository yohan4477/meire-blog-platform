/**
 * ðŸŽ¯ í´ë¡œë“œ AI ìƒì„¸ ì¢…ëª©ë³„ íŠ¹ì„± ë°˜ì˜ ê°ì • ë¶„ì„
 */

const sqlite3 = require('sqlite3').verbose();
const path = require('path');

class EnhancedSentimentAnalyzer {
  constructor() {
    const dbPath = path.join(process.cwd(), 'database.db');
    this.db = new sqlite3.Database(dbPath);
    
    // ì¢…ëª©ë³„ ìƒì„¸ ë¶„ì„ ì»¨í…ìŠ¤íŠ¸
    this.stockContexts = {
      '005930': {
        name: 'ì‚¼ì„±ì „ìž',
        keywords: ['ì‚¼ì„±ì „ìž', 'ì‚¼ì„±', 'Samsung', 'ë©”ëª¨ë¦¬', 'DRAM', 'NAND', 'íŒŒìš´ë“œë¦¬', 'HBM'],
        industry: 'ë°˜ë„ì²´',
        businessModel: 'ë©”ëª¨ë¦¬ ë°˜ë„ì²´ ì„¸ê³„ 1ìœ„, íŒŒìš´ë“œë¦¬ 2ìœ„',
        keyDrivers: {
          positive: {
            'AI ìˆ˜ìš”': 'AI ì„œë²„ìš© ë©”ëª¨ë¦¬ ìˆ˜ìš” ê¸‰ì¦ìœ¼ë¡œ ì‚¼ì„±ì „ìž ë©”ëª¨ë¦¬ ì‚¬ì—… í˜¸í™©',
            'ë©”ëª¨ë¦¬ ì‚¬ì´í´': 'ë©”ëª¨ë¦¬ ë°˜ë„ì²´ ì—…í™© íšŒë³µìœ¼ë¡œ ì‚¼ì„±ì „ìž ìˆ˜ìµì„± ëŒ€í­ ê°œì„ ',
            'ì• í”Œ íŒŒíŠ¸ë„ˆì‹­': 'ì• í”Œê³¼ì˜ í˜‘ì—… í™•ëŒ€ë¡œ ì‚¼ì„±ì „ìž ë””ìŠ¤í”Œë ˆì´ ë° ë°˜ë„ì²´ ìˆ˜ì£¼ ì¦ê°€',
            'HBM ì–‘ì‚°': 'ê³ ë¶€ê°€ê°€ì¹˜ HBM ë©”ëª¨ë¦¬ ì–‘ì‚°ìœ¼ë¡œ ì‚¼ì„±ì „ìž í”„ë¦¬ë¯¸ì—„ ì‹œìž¥ ì„ ì ',
            'íŒŒìš´ë“œë¦¬ ê²½ìŸë ¥': 'TSMC ëŒ€ë¹„ íŒŒìš´ë“œë¦¬ ê¸°ìˆ ê²©ì°¨ ì¶•ì†Œë¡œ ì‚¼ì„±ì „ìž ìœ„íƒìƒì‚° ìˆ˜ì£¼ í™•ëŒ€'
          },
          negative: {
            'ì¤‘êµ­ ê²½ìŸ': 'ì¤‘êµ­ ë©”ëª¨ë¦¬ ì—…ì²´ë“¤ì˜ ê¸°ìˆ  ì¶”ê²©ìœ¼ë¡œ ì‚¼ì„±ì „ìž ì‹œìž¥ì ìœ ìœ¨ ì••ë°•',
            'ë©”ëª¨ë¦¬ ì¹¨ì²´': 'ë©”ëª¨ë¦¬ ë°˜ë„ì²´ ê°€ê²© í•˜ë½ìœ¼ë¡œ ì‚¼ì„±ì „ìž ìˆ˜ìµì„± ì•…í™”',
            'ì• í”Œ ì˜ì¡´ë„': 'ì• í”Œ ë§¤ì¶œ ë¹„ì¤‘ì´ ë†’ì•„ ì• í”Œ ì‹¤ì ì— ì‚¼ì„±ì „ìžë„ ì—°ë™ ìœ„í—˜',
            'TSMC ê²©ì°¨': 'íŒŒìš´ë“œë¦¬ ê¸°ìˆ ê²©ì°¨ë¡œ ì‚¼ì„±ì „ìžê°€ ì£¼ìš” ê³ ê°ì‚¬ í™•ë³´ ì–´ë ¤ì›€'
          }
        }
      },
      
      'TSLA': {
        name: 'í…ŒìŠ¬ë¼',
        keywords: ['í…ŒìŠ¬ë¼', 'Tesla', 'ì¼ë¡ ë¨¸ìŠ¤í¬', 'ì „ê¸°ì°¨', 'EV', 'ìžìœ¨ì£¼í–‰', 'FSD'],
        industry: 'ì „ê¸°ì°¨',
        businessModel: 'í”„ë¦¬ë¯¸ì—„ ì „ê¸°ì°¨ ì„ ë„ì—…ì²´, ìžìœ¨ì£¼í–‰ ê¸°ìˆ  í˜ì‹ ',
        keyDrivers: {
          positive: {
            'ì „ê¸°ì°¨ ë³´ê¸‰': 'ê¸€ë¡œë²Œ íƒ„ì†Œì¤‘ë¦½ ì •ì±…ìœ¼ë¡œ ì „ê¸°ì°¨ ìˆ˜ìš” ê¸‰ì¦, í…ŒìŠ¬ë¼ ì‹œìž¥ì„ ë„ ì§€ìœ„ ê°•í™”',
            'ìžìœ¨ì£¼í–‰ í˜ì‹ ': 'FSD ê¸°ìˆ  ë°œì „ìœ¼ë¡œ í…ŒìŠ¬ë¼ ì†Œí”„íŠ¸ì›¨ì–´ ë§¤ì¶œ ë° ê¸°ì—…ê°€ì¹˜ ê¸‰ìƒìŠ¹',
            'ì¤‘êµ­ ì‹œìž¥': 'ì¤‘êµ­ ìƒí•˜ì´ ê¸°ê°€íŒ©í† ë¦¬ í’€ê°€ë™ìœ¼ë¡œ í…ŒìŠ¬ë¼ ê¸€ë¡œë²Œ ìƒì‚°ëŠ¥ë ¥ ë° ë¹„ìš©ê²½ìŸë ¥ í™•ë³´',
            'ë°°í„°ë¦¬ í˜ì‹ ': '4680 ë°°í„°ë¦¬ ì–‘ì‚°ìœ¼ë¡œ í…ŒìŠ¬ë¼ ì›ê°€ì ˆê° ë° ì—ë„ˆì§€ë°€ë„ í–¥ìƒ',
            'ë¡œë³´íƒì‹œ': 'ë¬´ì¸íƒì‹œ ìƒìš©í™”ì‹œ í…ŒìŠ¬ë¼ ìƒˆë¡œìš´ ìˆ˜ìµëª¨ë¸ ì°½ì¶œ'
          },
          negative: {
            'ì¤‘êµ­ ê²½ìŸ': 'BYD ë“± ì¤‘êµ­ ì „ê¸°ì°¨ ì—…ì²´ë“¤ì˜ ê³µê²©ì  ê°€ê²©ì •ì±…ìœ¼ë¡œ í…ŒìŠ¬ë¼ ì‹œìž¥ì ìœ ìœ¨ í•˜ë½',
            'ìžìœ¨ì£¼í–‰ ê·œì œ': 'ìžìœ¨ì£¼í–‰ ì•ˆì „ì‚¬ê³  ë°œìƒì‹œ í…ŒìŠ¬ë¼ ê·œì œê°•í™” ë° ê¸°ìˆ ë°œì „ ì§€ì—°',
            'ì „ê¸°ì°¨ ë³´ì¡°ê¸ˆ': 'ê°êµ­ ì „ê¸°ì°¨ ë³´ì¡°ê¸ˆ ì¶•ì†Œë¡œ í…ŒìŠ¬ë¼ ìˆ˜ìš” ë‘”í™” ìš°ë ¤',
            'í’ˆì§ˆ ë¬¸ì œ': 'í…ŒìŠ¬ë¼ ì°¨ëŸ‰ ë¦¬ì½œ ë° í’ˆì§ˆë¬¸ì œë¡œ ë¸Œëžœë“œ ì´ë¯¸ì§€ íƒ€ê²©'
          }
        }
      },
      
      'NVDA': {
        name: 'ì—”ë¹„ë””ì•„',
        keywords: ['ì—”ë¹„ë””ì•„', 'NVIDIA', 'GPU', 'AI', 'ì  ìŠ¨í™©', 'CUDA', 'ë°ì´í„°ì„¼í„°'],
        industry: 'AI/GPU',
        businessModel: 'AI ê°€ì† ì»´í“¨íŒ… ì ˆëŒ€ê°•ìž, GPU ì‹œìž¥ ë…ì ',
        keyDrivers: {
          positive: {
            'AI í˜ëª…': 'ChatGPT ë“± ìƒì„±AI ì—´í’ìœ¼ë¡œ ì—”ë¹„ë””ì•„ AI ì¹© ìˆ˜ìš” í­ë°œì  ì¦ê°€',
            'ë°ì´í„°ì„¼í„°': 'í´ë¼ìš°ë“œ ê¸°ì—…ë“¤ì˜ AI ì¸í”„ë¼ íˆ¬ìž í™•ëŒ€ë¡œ ì—”ë¹„ë””ì•„ H100 ë“± ë§¤ì¶œ ê¸‰ì„±ìž¥',
            'CUDA ìƒíƒœê³„': 'CUDA ì†Œí”„íŠ¸ì›¨ì–´ í”Œëž«í¼ í™•ì‚°ìœ¼ë¡œ ì—”ë¹„ë””ì•„ ê¸°ìˆ ì¢…ì†ì„± ì‹¬í™”',
            'ë°˜ë„ì²´ ì„¤ê³„': 'ìµœì²¨ë‹¨ AI ì¹© ì„¤ê³„ëŠ¥ë ¥ìœ¼ë¡œ ì—”ë¹„ë””ì•„ ê²½ìŸì‚¬ ëŒ€ë¹„ ê¸°ìˆ ì  ìš°ìœ„ ì§€ì†'
          },
          negative: {
            'ì¤‘êµ­ ì œìž¬': 'ë¯¸êµ­ì˜ ëŒ€ì¤‘ ë°˜ë„ì²´ ìˆ˜ì¶œì œìž¬ë¡œ ì—”ë¹„ë””ì•„ ì¤‘êµ­ì‹œìž¥ ë§¤ì¶œ íƒ€ê²©',
            'AI ë²„ë¸”': 'AI íˆ¬ìž ê³¼ì—´ ìš°ë ¤ë¡œ ì—”ë¹„ë””ì•„ ì£¼ê°€ ì¡°ì • ì••ë ¥',
            'ê²½ìŸ ì‹¬í™”': 'AMD, ì¸í…” ë“± ê²½ìŸì‚¬ AI ì¹© ê°œë°œë¡œ ì—”ë¹„ë””ì•„ ë…ì ì§€ìœ„ ìœ„í˜‘',
            'ê³ ê° ì§‘ì¤‘': 'ë¹…í…Œí¬ ê³ ê° ì§‘ì¤‘ë„ê°€ ë†’ì•„ ì£¼ìš” ê³ ê°ì‚¬ íˆ¬ìž ì¶•ì†Œì‹œ ì—”ë¹„ë””ì•„ íƒ€ê²©'
          }
        }
      },
      
      '267250': {
        name: 'HDí˜„ëŒ€',
        keywords: ['HDí˜„ëŒ€', 'í˜„ëŒ€ì¤‘ê³µì—…', 'í˜„ëŒ€', 'ì¡°ì„ ', 'í•´ìƒí’ë ¥', 'LNG', 'ì¹œí™˜ê²½ì„ ë°•'],
        industry: 'ì¡°ì„ /ì¤‘ê³µì—…',
        businessModel: 'ê¸€ë¡œë²Œ ì¡°ì„ ì—… Big3, ì¹œí™˜ê²½ ì„ ë°• ê¸°ìˆ  ì„ ë„',
        keyDrivers: {
          positive: {
            'ì¹œí™˜ê²½ ì„ ë°•': 'IMO í™˜ê²½ê·œì œ ê°•í™”ë¡œ ì¹œí™˜ê²½ ì„ ë°• ìˆ˜ìš” ê¸‰ì¦, HDí˜„ëŒ€ ê¸°ìˆ ë ¥ ìš°ìœ„',
            'í•´ìƒí’ë ¥': 'ê¸€ë¡œë²Œ í•´ìƒí’ë ¥ í”„ë¡œì íŠ¸ í™•ëŒ€ë¡œ HDí˜„ëŒ€ í•´ìƒí’ë ¥ ì„¤ì¹˜ì„  ìˆ˜ì£¼ ì¦ê°€',
            'LNG ì„ ë°•': 'ì²œì—°ê°€ìŠ¤ ìš´ì†¡ ì¦ê°€ë¡œ LNG ìš´ë°˜ì„  ìˆ˜ìš” í™•ëŒ€, HDí˜„ëŒ€ ìˆ˜ì£¼ í˜¸ì¡°',
            'ì •ë¶€ ì§€ì›': 'K-ì¡°ì„  ìž¬ë„ì•½ ì •ì±…ìœ¼ë¡œ HDí˜„ëŒ€ ê¸°ìˆ ê°œë°œ ì§€ì› ë° ìˆ˜ì£¼ ê²½ìŸë ¥ ê°•í™”'
          },
          negative: {
            'ì¤‘êµ­ ê²½ìŸ': 'ì¤‘êµ­ ì¡°ì„ ì—…ì²´ë“¤ì˜ ì €ê°€ ê³µì„¸ë¡œ HDí˜„ëŒ€ ìˆ˜ì£¼ ê²½ìŸ ì‹¬í™”',
            'ì›ìžìž¬ ê°€ê²©': 'ì² ê°• ë“± ì›ìžìž¬ ê°€ê²© ìƒìŠ¹ìœ¼ë¡œ HDí˜„ëŒ€ ì¡°ì„ ì—… ìˆ˜ìµì„± ì••ë°•',
            'ìˆ˜ì£¼ ë³€ë™ì„±': 'ì¡°ì„ ì—… íŠ¹ì„±ìƒ ìˆ˜ì£¼ íƒ€ì´ë°ì— ë”°ë¥¸ ì‹¤ì  ë³€ë™ì„±ì´ HDí˜„ëŒ€ ì£¼ê°€ì— ì˜í–¥',
            'ë…¸ì‚¬ê°ˆë“±': 'ì¡°ì„ ì—… ìž„ê¸ˆí˜‘ìƒ ë“± ë…¸ì‚¬ë¬¸ì œ ë°œìƒì‹œ HDí˜„ëŒ€ ìƒì‚°ì°¨ì§ˆ ìš°ë ¤'
          }
        }
      },
      
      'LLY': {
        name: 'ì¼ë¼ì´ë¦´ë¦¬',
        keywords: ['ì¼ë¼ì´ë¦´ë¦¬', 'Eli Lilly', 'ë¦´ë¦¬', 'Lilly', 'ë‹¹ë‡¨ë³‘', 'ë¹„ë§Œ', 'ë§ˆìš´ìžë¡œ', 'ì•Œì¸ í•˜ì´ë¨¸'],
        industry: 'ì œì•½/ë°”ì´ì˜¤',
        businessModel: 'ë‹¹ë‡¨Â·ë¹„ë§Œ ì¹˜ë£Œì œ ê¸€ë¡œë²Œ ì„ ë„, ì‹ ì•½ê°œë°œ í˜ì‹ ê¸°ì—…',
        keyDrivers: {
          positive: {
            'ë‹¹ë‡¨ë³‘ ì¹˜ë£Œì œ': 'ê¸€ë¡œë²Œ ë‹¹ë‡¨ë³‘ í™˜ìž ì¦ê°€ë¡œ ì¼ë¼ì´ë¦´ë¦¬ ì¸ìŠë¦° ë“± ì¹˜ë£Œì œ ì‹œìž¥ í™•ëŒ€',
            'ë¹„ë§Œ ì¹˜ë£Œì œ': 'ë§ˆìš´ìžë¡œ ë“± í˜ì‹ ì  ë¹„ë§Œì¹˜ë£Œì œë¡œ ì¼ë¼ì´ë¦´ë¦¬ ìƒˆë¡œìš´ ì„±ìž¥ë™ë ¥ í™•ë³´',
            'ì•Œì¸ í•˜ì´ë¨¸ ì‹ ì•½': 'ì¹˜ë§¤ ì¹˜ë£Œì œ ê°œë°œ ì„±ê³µì‹œ ì¼ë¼ì´ë¦´ë¦¬ ìˆ˜ì‹­ì¡° ì‹œìž¥ ì„ ì  ê°€ëŠ¥',
            'FDA ìŠ¹ì¸': 'ì‹ ì•½ FDA ìŠ¹ì¸ìœ¼ë¡œ ì¼ë¼ì´ë¦´ë¦¬ ì œí’ˆ í¬íŠ¸í´ë¦¬ì˜¤ í™•ìž¥ ë° ë§¤ì¶œ ì„±ìž¥'
          },
          negative: {
            'íŠ¹í—ˆ ì ˆë²½': 'ì£¼ë ¥ ì˜ì•½í’ˆ íŠ¹í—ˆ ë§Œë£Œë¡œ ì¼ë¼ì´ë¦´ë¦¬ ì œë„¤ë¦­ ê²½ìŸ ë° ë§¤ì¶œ ê°ì†Œ',
            'ìž„ìƒ ì‹¤íŒ¨': 'ì‹ ì•½ ìž„ìƒì‹œí—˜ ì‹¤íŒ¨ë¡œ ì¼ë¼ì´ë¦´ë¦¬ R&D íˆ¬ìžì†ì‹¤ ë° ì„±ìž¥ë™ë ¥ ìƒì‹¤',
            'ì•½ê°€ ê·œì œ': 'ê°êµ­ ì•½ê°€ ì¸í•˜ ì •ì±…ìœ¼ë¡œ ì¼ë¼ì´ë¦´ë¦¬ ì˜ì•½í’ˆ ìˆ˜ìµì„± ì••ë°•',
            'ë¶€ìž‘ìš© ì´ìŠˆ': 'ì˜ì•½í’ˆ ë¶€ìž‘ìš© ë°œìƒì‹œ ì¼ë¼ì´ë¦´ë¦¬ ì œí’ˆ ì‹ ë¢°ë„ í•˜ë½ ë° ì†Œì†¡ ë¦¬ìŠ¤í¬'
          }
        }
      },
      
      'AAPL': {
        name: 'ì• í”Œ',
        keywords: ['ì• í”Œ', 'Apple', 'ì•„ì´í°', 'iPhone', 'iOS', 'ë§¥ë¶', 'AI'],
        industry: 'ê¸°ìˆ /ì†Œë¹„ìž¬',
        businessModel: 'í”„ë¦¬ë¯¸ì—„ ìŠ¤ë§ˆíŠ¸í° ìƒíƒœê³„, ì„œë¹„ìŠ¤ ìˆ˜ìµ í™•ëŒ€',
        keyDrivers: {
          positive: {
            'ì•„ì´í° í˜ì‹ ': 'ì•„ì´í° ì‹ ê¸°ëŠ¥ ì¶œì‹œë¡œ ì• í”Œ êµì²´ìˆ˜ìš” ì¦ê°€ ë° í”„ë¦¬ë¯¸ì—„ ê°€ê²© ìœ ì§€',
            'AI ê¸°ëŠ¥': 'ì• í”Œ AI ê¸°ëŠ¥ ê°•í™”ë¡œ ì•„ì´í° ì°¨ë³„í™” ë° ìƒíƒœê³„ ê²½ìŸë ¥ í–¥ìƒ',
            'ì„œë¹„ìŠ¤ ì„±ìž¥': 'ì•±ìŠ¤í† ì–´, iCloud ë“± ì• í”Œ ì„œë¹„ìŠ¤ ë§¤ì¶œ ì„±ìž¥ìœ¼ë¡œ ìˆ˜ìµì„± ê°œì„ ',
            'ì¸ë„ ì‹œìž¥': 'ì¸ë„ ë“± ì‹ í¥ì‹œìž¥ ì§„ì¶œë¡œ ì• í”Œ ê¸€ë¡œë²Œ ì‹œìž¥ì ìœ ìœ¨ í™•ëŒ€'
          },
          negative: {
            'ì¤‘êµ­ íŒë§¤ ë¶€ì§„': 'ì¤‘êµ­ ë‚´ ë°˜ë¯¸ê°ì •ìœ¼ë¡œ ì• í”Œ ì•„ì´í° íŒë§¤ ê¸‰ê°',
            'í˜ì‹  í•œê³„': 'ì•„ì´í° í˜ì‹  ë‘”í™”ë¡œ ì• í”Œ êµì²´ì£¼ê¸° ì—°ìž¥ ë° ë§¤ì¶œ ì„±ìž¥ í•œê³„',
            'ê²½ìŸ ì‹¬í™”': 'ì‚¼ì„±, ì¤‘êµ­ì—…ì²´ ë“±ê³¼ì˜ ê²½ìŸìœ¼ë¡œ ì• í”Œ ì‹œìž¥ì ìœ ìœ¨ ì••ë°•',
            'ê³µê¸‰ë§ ë¦¬ìŠ¤í¬': 'ì¤‘êµ­ ì˜ì¡´ë„ ë†’ì€ ê³µê¸‰ë§ìœ¼ë¡œ ì• í”Œ ì§€ì •í•™ì  ë¦¬ìŠ¤í¬ ë…¸ì¶œ'
          }
        }
      }
    };
  }

  /**
   * ðŸŽ¯ ìƒì„¸ ì¢…ëª©ë³„ ê°ì • ë¶„ì„
   */
  async performDetailedAnalysis() {
    console.log('ðŸŽ¯ í´ë¡œë“œ AI ìƒì„¸ ì¢…ëª©ë³„ íŠ¹ì„± ê°ì • ë¶„ì„ ì‹œìž‘...');
    
    const posts = await this.getBlogPosts();
    console.log(`ðŸ“ ë¶„ì„ ëŒ€ìƒ: ${posts.length}ê°œ í¬ìŠ¤íŠ¸`);
    
    let totalAnalyzed = 0;
    
    for (const post of posts) {
      const results = [];
      
      for (const [ticker, context] of Object.entries(this.stockContexts)) {
        const analysis = await this.analyzePostForStock(post, ticker, context);
        if (analysis) {
          await this.saveSentiment(post.id, ticker, analysis);
          results.push(`${context.name}:${analysis.sentiment}`);
        }
      }
      
      if (results.length > 0) {
        console.log(`  ðŸ“Š ${post.title.substring(0, 50)}... â†’ ${results.join(', ')}`);
        totalAnalyzed++;
      }
    }
    
    console.log(`\nâœ… ìƒì„¸ ë¶„ì„ ì™„ë£Œ: ${totalAnalyzed}ê°œ í¬ìŠ¤íŠ¸ì—ì„œ ì¢…ëª©ë³„ íŠ¹ì„± ë°˜ì˜`);
    this.db.close();
  }

  /**
   * í¬ìŠ¤íŠ¸ë³„ ì¢…ëª© ìƒì„¸ ë¶„ì„
   */
  async analyzePostForStock(post, ticker, context) {
    const fullText = `${post.title} ${post.content || ''}`.toLowerCase();
    
    // ì¢…ëª© ì–¸ê¸‰ ì—¬ë¶€ í™•ì¸
    const isMentioned = context.keywords.some(keyword => 
      fullText.includes(keyword.toLowerCase())
    );
    
    if (!isMentioned) return null;
    
    // ìƒì„¸ ê°ì • ë¶„ì„ ìˆ˜í–‰
    const analysis = this.performContextualAnalysis(fullText, context);
    
    return analysis;
  }

  /**
   * ðŸŽ¯ ì»¨í…ìŠ¤íŠ¸ ê¸°ë°˜ ìƒì„¸ ê°ì • ë¶„ì„
   */
  performContextualAnalysis(text, context) {
    let positiveMatches = [];
    let negativeMatches = [];
    
    // ê¸ì •ì  ë™ì¸ ë¶„ì„
    for (const [key, description] of Object.entries(context.keyDrivers.positive)) {
      if (this.detectKeyDriver(text, key)) {
        positiveMatches.push(description);
      }
    }
    
    // ë¶€ì •ì  ë™ì¸ ë¶„ì„  
    for (const [key, description] of Object.entries(context.keyDrivers.negative)) {
      if (this.detectKeyDriver(text, key)) {
        negativeMatches.push(description);
      }
    }
    
    // ê°ì • ë° ìƒì„¸ ê·¼ê±° ê²°ì •
    let sentiment, reasoning;
    
    if (positiveMatches.length > negativeMatches.length) {
      sentiment = 'positive';
      reasoning = `${context.businessModel}. ${positiveMatches[0] || 'ê¸ì •ì  ì‚¬ì—…í™˜ê²½ ë³€í™” ê°ì§€'}`;
    } else if (negativeMatches.length > positiveMatches.length) {
      sentiment = 'negative';
      reasoning = `${context.businessModel}. ${negativeMatches[0] || 'ë¶€ì •ì  ë¦¬ìŠ¤í¬ ìš”ì¸ ì‹ë³„'}`;
    } else {
      sentiment = 'neutral';
      reasoning = `${context.businessModel}. ${context.industry} ì—…ê³„ ì¼ë°˜ì  ì–¸ê¸‰ìœ¼ë¡œ ëª…í™•í•œ íˆ¬ìž ìž„íŒ©íŠ¸ ì œí•œì `;
    }
    
    return {
      sentiment,
      score: positiveMatches.length - negativeMatches.length,
      reasoning: reasoning
    };
  }

  /**
   * í‚¤ ë“œë¼ì´ë²„ ê°ì§€ ë¡œì§
   */
  detectKeyDriver(text, keyDriver) {
    const patterns = {
      'AI ìˆ˜ìš”': /ai|ì¸ê³µì§€ëŠ¥|ë¨¸ì‹ ëŸ¬ë‹|ë”¥ëŸ¬ë‹|chatgpt/,
      'ë©”ëª¨ë¦¬ ì‚¬ì´í´': /ë©”ëª¨ë¦¬|dram|nand|ë°˜ë„ì²´.*í˜¸í™©|ë°˜ë„ì²´.*íšŒë³µ/,
      'ì• í”Œ íŒŒíŠ¸ë„ˆì‹­': /ì• í”Œ.*ê³„ì•½|ì• í”Œ.*í˜‘ì—…|ì•„ì´í°.*ìƒì‚°/,
      'HBM ì–‘ì‚°': /hbm|ê³ ëŒ€ì—­í­.*ë©”ëª¨ë¦¬|ai.*ë©”ëª¨ë¦¬/,
      'íŒŒìš´ë“œë¦¬ ê²½ìŸë ¥': /íŒŒìš´ë“œë¦¬|ìœ„íƒìƒì‚°|tsmc/,
      'ì¤‘êµ­ ê²½ìŸ': /ì¤‘êµ­.*ê²½ìŸ|ì¤‘êµ­.*ì—…ì²´|ymtc/,
      'ë©”ëª¨ë¦¬ ì¹¨ì²´': /ë©”ëª¨ë¦¬.*ê°€ê²©.*í•˜ë½|ë©”ëª¨ë¦¬.*ì¹¨ì²´|ë°˜ë„ì²´.*ë¶€ì§„/,
      'ì• í”Œ ì˜ì¡´ë„': /ì• í”Œ.*ì˜ì¡´|ì•„ì´í°.*íŒë§¤.*ë¶€ì§„/,
      'TSMC ê²©ì°¨': /tsmc.*ê²©ì°¨|íŒŒìš´ë“œë¦¬.*ê²©ì°¨/,
      
      'ì „ê¸°ì°¨ ë³´ê¸‰': /ì „ê¸°ì°¨.*ë³´ê¸‰|ev.*ìˆ˜ìš”|íƒ„ì†Œì¤‘ë¦½/,
      'ìžìœ¨ì£¼í–‰ í˜ì‹ ': /ìžìœ¨ì£¼í–‰|fsd|ì™„ì „.*ìžìœ¨/,
      'ì¤‘êµ­ ì‹œìž¥': /ì¤‘êµ­.*ì‹œìž¥|ìƒí•˜ì´.*ê³µìž¥|ì¤‘êµ­.*íŒë§¤/,
      'ë°°í„°ë¦¬ í˜ì‹ ': /ë°°í„°ë¦¬.*ê¸°ìˆ |4680.*ë°°í„°ë¦¬/,
      'ë¡œë³´íƒì‹œ': /ë¡œë³´íƒì‹œ|ë¬´ì¸.*íƒì‹œ|ìžìœ¨.*íƒì‹œ/,
      
      'AI í˜ëª…': /ai.*í˜ëª…|ai.*ë¶|chatgpt.*ì—´í’/,
      'ë°ì´í„°ì„¼í„°': /ë°ì´í„°ì„¼í„°|í´ë¼ìš°ë“œ.*íˆ¬ìž|h100/,
      'CUDA ìƒíƒœê³„': /cuda|gpu.*í”Œëž«í¼/,
      'ë°˜ë„ì²´ ì„¤ê³„': /ai.*ì¹©|gpu.*ì„¤ê³„/,
      
      'ì¹œí™˜ê²½ ì„ ë°•': /ì¹œí™˜ê²½.*ì„ ë°•|ê·¸ë¦°.*ì„ ë°•|imo.*ê·œì œ/,
      'í•´ìƒí’ë ¥': /í•´ìƒí’ë ¥|í•´ìƒ.*í’ë ¥/,
      'LNG ì„ ë°•': /lng.*ì„ ë°•|lng.*ìš´ë°˜ì„ /,
      'ì •ë¶€ ì§€ì›': /k.*ì¡°ì„ |ì¡°ì„ .*ì •ì±…|ì •ë¶€.*ì§€ì›/,
      'ì›ìžìž¬ ê°€ê²©': /ì² ê°•.*ê°€ê²©|ì›ìžìž¬.*ê°€ê²©.*ìƒìŠ¹/,
      'ìˆ˜ì£¼ ë³€ë™ì„±': /ìˆ˜ì£¼.*ë³€ë™|ì¡°ì„ ì—….*íŠ¹ì„±/,
      'ë…¸ì‚¬ê°ˆë“±': /ìž„ê¸ˆí˜‘ìƒ|ë…¸ì‚¬.*ê°ˆë“±|íŒŒì—…/,
      
      'ë‹¹ë‡¨ë³‘ ì¹˜ë£Œì œ': /ë‹¹ë‡¨ë³‘|ì¸ìŠë¦°|í˜ˆë‹¹/,
      'ë¹„ë§Œ ì¹˜ë£Œì œ': /ë¹„ë§Œ.*ì¹˜ë£Œ|ë§ˆìš´ìžë¡œ|ë‹¤ì´ì–´íŠ¸.*ì•½/,
      'ì•Œì¸ í•˜ì´ë¨¸ ì‹ ì•½': /ì•Œì¸ í•˜ì´ë¨¸|ì¹˜ë§¤.*ì¹˜ë£Œ|ë‡Œ.*ì§ˆí™˜/,
      'FDA ìŠ¹ì¸': /fda.*ìŠ¹ì¸|ì‹ ì•½.*ìŠ¹ì¸/,
      'íŠ¹í—ˆ ì ˆë²½': /íŠ¹í—ˆ.*ë§Œë£Œ|ì œë„¤ë¦­.*ê²½ìŸ/,
      'ìž„ìƒ ì‹¤íŒ¨': /ìž„ìƒ.*ì‹¤íŒ¨|ìž„ìƒì‹œí—˜.*ë¶€ì •ì /,
      'ì•½ê°€ ê·œì œ': /ì•½ê°€.*ì¸í•˜|ì˜ë£Œë³´í—˜/,
      'ë¶€ìž‘ìš© ì´ìŠˆ': /ë¶€ìž‘ìš©|ì•ˆì „ì„±.*ë¬¸ì œ/,
      
      'ì•„ì´í° í˜ì‹ ': /ì•„ì´í°.*ì‹ ì œí’ˆ|ì•„ì´í°.*í˜ì‹ |ios/,
      'AI ê¸°ëŠ¥': /ì• í”Œ.*ai|ì•„ì´í°.*ai/,
      'ì„œë¹„ìŠ¤ ì„±ìž¥': /ì•±ìŠ¤í† ì–´|icloud|ì• í”Œ.*ì„œë¹„ìŠ¤/,
      'ì¸ë„ ì‹œìž¥': /ì¸ë„.*ì‹œìž¥|ì‹ í¥.*ì‹œìž¥/,
      'í˜ì‹  í•œê³„': /í˜ì‹ .*í•œê³„|í˜ì‹ .*ë‘”í™”/,
      'ê³µê¸‰ë§ ë¦¬ìŠ¤í¬': /ê³µê¸‰ë§|ì¤‘êµ­.*ì˜ì¡´/
    };
    
    const pattern = patterns[keyDriver];
    return pattern ? pattern.test(text) : false;
  }

  /**
   * 1ë…„ì¹˜ ë¸”ë¡œê·¸ í¬ìŠ¤íŠ¸ ì¡°íšŒ
   */
  async getBlogPosts() {
    return new Promise((resolve, reject) => {
      const oneYearAgo = new Date();
      oneYearAgo.setFullYear(oneYearAgo.getFullYear() - 1);
      const dateFrom = oneYearAgo.toISOString().split('T')[0];
      
      this.db.all(`
        SELECT id, title, content, created_date
        FROM blog_posts 
        WHERE created_date >= ?
        ORDER BY created_date DESC
      `, [dateFrom], (err, rows) => {
        if (err) reject(err);
        else resolve(rows || []);
      });
    });
  }

  /**
   * ê°ì • ë¶„ì„ ê²°ê³¼ ì €ìž¥
   */
  async saveSentiment(postId, ticker, analysis) {
    return new Promise((resolve, reject) => {
      this.db.run(`
        INSERT OR REPLACE INTO sentiments (
          post_id, ticker, sentiment, sentiment_score, 
          key_reasoning, created_at
        ) VALUES (?, ?, ?, ?, ?, datetime('now'))
      `, [
        postId, ticker, analysis.sentiment, 
        analysis.score, analysis.reasoning
      ], function(err) {
        if (err) reject(err);
        else resolve(this.lastID);
      });
    });
  }
}

// ì‹¤í–‰
const analyzer = new EnhancedSentimentAnalyzer();
analyzer.performDetailedAnalysis().catch(console.error);