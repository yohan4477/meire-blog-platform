'use client';

import { useState, useEffect } from 'react';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Badge } from '@/components/ui/badge';
import { Button } from '@/components/ui/button';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';
import { Calendar, User, Tag, Eye, MessageSquare, Heart, Share2, Filter, FileText, AlertCircle, Grid3X3, List } from 'lucide-react';
import Link from 'next/link';
import { useOptimizedLoading } from '@/hooks/useOptimizedLoading';
import { EmptyState } from '@/components/ui/loading-states';

interface MerryPost {
  id: number;
  title: string;
  content: string;
  excerpt: string;
  category: string;
  author: string;
  createdAt: string;
  views: number;
  likes: number;
  comments: number;
  tags: string[];
  featured: boolean;
  // ìƒˆë¡œìš´ í•„ë“œë“¤ ì¶”ê°€
  mentionedStocks?: string[];
  investmentTheme?: string;
  sentimentTone?: string;
  // Claude ë¶„ì„ ê²°ê³¼
  claudeSummary?: string;
}

export default function MerryPage() {
  const [posts, setPosts] = useState<MerryPost[]>([]);
  const [hasMore, setHasMore] = useState(true);
  const [totalPosts, setTotalPosts] = useState<number>(0);
  const [dateFilter, setDateFilter] = useState<string>('all');
  const [tickerFilter, setTickerFilter] = useState<string>('all');
  const [availableStocks, setAvailableStocks] = useState<Array<{ticker: string, name: string, count: number}>>([]);
  const [viewMode, setViewMode] = useState<'card' | 'list'>('card');
  
  // ğŸš€ ìµœì í™”ëœ ë¡œë”© ìƒíƒœ ê´€ë¦¬
  const mainLoading = useOptimizedLoading({
    minLoadingTime: 500,
    maxLoadingTime: 10000,
    retryAttempts: 3
  });
  const loadMoreLoading = useOptimizedLoading({
    minLoadingTime: 300,
    retryAttempts: 2
  });
  const stocksLoading = useOptimizedLoading({ minLoadingTime: 200 });

  // í•„í„° ë³€ê²½ì‹œ í¬ìŠ¤íŠ¸ ë‹¤ì‹œ ë¡œë“œ
  useEffect(() => {
    loadPosts(true);
  }, [dateFilter, tickerFilter]);

  // ì´ˆê¸° ë¡œë“œ ë° ì¢…ëª© ëª©ë¡ ë¡œë“œ
  useEffect(() => {
    loadPosts(true);
    loadAvailableStocks();
  }, []);

  const loadAvailableStocks = async () => {
    const result = await stocksLoading.fetchWithLoading('/api/merry/stocks');
      
    if (result?.success && result.data?.stocks) {
      // ì–¸ê¸‰ íšŸìˆ˜ê°€ ìˆëŠ” ì¢…ëª©ë§Œ í•„í„°ë§í•˜ê³  ì •ë ¬
      const stocksWithMentions = result.data.stocks
        .filter((stock: any) => stock.mention_count > 0)
        .map((stock: any) => ({
          ticker: stock.ticker,
          name: stock.name || stock.ticker,
          count: stock.mention_count
        }))
        .sort((a: any, b: any) => b.count - a.count);
      
      setAvailableStocks(stocksWithMentions);
    }
  };

  const loadPosts = async (resetPosts = false) => {
    const loading = resetPosts ? mainLoading : loadMoreLoading;
    
    if (resetPosts) {
      setPosts([]);
    }

    const result = await loading.fetchWithLoading(
      `/api/merry/posts?${buildQueryParams(resetPosts)}`,
      {},
      (response) => response.json()
    );
      
    if (result?.success && result.data) {
      // API ë°ì´í„°ë¥¼ MerryPost í˜•ì‹ìœ¼ë¡œ ë³€í™˜
      const formattedPosts: MerryPost[] = result.data.map((post: any) => ({
        id: post.id,
        title: post.title,
        content: post.content || post.excerpt,
        excerpt: post.excerpt || post.content?.substring(0, 200) + '...',
        category: post.category || 'ì¼ë°˜',
        author: 'ë©”ë¥´',
        createdAt: post.createdAt || post.date,
        views: post.views || 0,
        likes: post.likes || 0,
        comments: post.comments || 0,
        tags: post.tags || [],
        featured: post.featured || false,
        claudeSummary: post.claudeSummary || post.excerpt || post.content?.substring(0, 150) + '...'
      }));
      
      if (resetPosts) {
        setPosts(formattedPosts);
      } else {
        setPosts(prev => [...prev, ...formattedPosts]);
      }
      
      // ë” ë³´ê¸° ë²„íŠ¼ í‘œì‹œ ì—¬ë¶€ ê²°ì •
      setHasMore(result.meta?.hasNext || false);
      
      // ì´ í¬ìŠ¤íŠ¸ ìˆ˜ ì—…ë°ì´íŠ¸
      if (result.meta?.total !== undefined) {
        setTotalPosts(result.meta.total);
      }
    }
  };
  
  const buildQueryParams = (resetPosts: boolean) => {
    const offset = resetPosts ? 0 : posts.length;
    const limit = 10;
    
    const params = new URLSearchParams({
      limit: limit.toString(),
      offset: offset.toString()
    });
    
    if (dateFilter && dateFilter !== 'all') params.append('date', dateFilter);
    if (tickerFilter && tickerFilter !== 'all') params.append('ticker', tickerFilter);
    
    return params.toString();
  };

  const loadMorePosts = () => {
    if (!loadMoreLoading.isLoading && hasMore) {
      loadPosts(false);
    }
  };

  const formatDate = (dateString: string) => {
    return new Date(dateString).toLocaleDateString('ko-KR', {
      year: 'numeric',
      month: 'long',
      day: 'numeric'
    });
  };

  // ğŸ“ ì •í™•í•œ í•œ ì¤„ ìš”ì•½ ì¶”ì¶œ (ë©”ë¥´ë‹˜ í•œ ì¤„ ìš”ì•½ ë‹¤ìŒ ì²« ë¬¸ì¥ë§Œ)
  const extractMerrySummary = (content: string): string => {
    try {
      if (!content) return '';
      
      // 1ë‹¨ê³„: "ë©”ë¥´ë‹˜ í•œ ì¤„ ìš”ì•½" ë‹¤ìŒ ì²« ë²ˆì§¸ ë¬¸ë‹¨ë§Œ ì •í™•íˆ ì¶”ì¶œ
      if (content.includes('ë©”ë¥´ë‹˜ í•œ ì¤„ ìš”ì•½')) {
        const summaryPart = content.split('ë©”ë¥´ë‹˜ í•œ ì¤„ ìš”ì•½')[1];
        if (summaryPart) {
          // ì²« ë²ˆì§¸ ë¹ˆ ì¤„ê¹Œì§€ë§Œ (ì‹¤ì œ í•œ ì¤„ ìš”ì•½ ë¬¸ë‹¨)
          let firstParagraph = summaryPart
            .replace(/^[\s\n\r]*/, '')    // ì• ê³µë°± ì œê±°
            .split(/\n\s*\n/)[0]          // ì²« ë²ˆì§¸ ë¬¸ë‹¨ë§Œ
            ?.trim();
            
          if (firstParagraph && firstParagraph.length > 10) {
            // 90ìë¡œ ì—„ê²©í•˜ê²Œ ì œí•œ (ì§„ì§œ í•œ ì¤„ ìš”ì•½ë§Œ)
            return firstParagraph.length > 90 ? firstParagraph.substring(0, 90) + '...' : firstParagraph;
          }
        }
      }
      
      // 2ë‹¨ê³„: ë‹¤ë¥¸ ìš”ì•½ íŒ¨í„´ë“¤ë„ ì²« ë²ˆì§¸ ë¬¸ì¥ë§Œ
      const patterns = ['í•œì¤„ìš”ì•½', 'ìš”ì•½:', 'ì •ë¦¬:', 'ê²°ë¡ :', 'í•µì‹¬:', 'í¬ì¸íŠ¸:'];
      
      for (const pattern of patterns) {
        if (content.includes(pattern)) {
          const afterPattern = content.split(pattern)[1];
          if (afterPattern) {
            let summary = afterPattern
              .replace(/^[\s\n\r:]*/, '')  // ì• ê³µë°± ì œê±°
              .split(/\n\s*\n/)[0]         // ì²« ë²ˆì§¸ ë¬¸ë‹¨ë§Œ
              ?.trim();
              
            if (summary && summary.length > 10) {
              return summary.length > 90 ? summary.substring(0, 90) + '...' : summary;
            }
          }
        }
      }
      
      // 3ë‹¨ê³„: ìš”ì•½ ì„¹ì…˜ì´ ì—†ìœ¼ë©´ ì²« ë²ˆì§¸ ë¬¸ì¥ë§Œ (ë§¤ìš° ì§§ê²Œ)
      const cleanContent = content
        .replace(/ë©”ë¥´ë‹˜ í•œ ì¤„ ìš”ì•½[\s\S]*?\n\n/, '') // ìš”ì•½ ì„¹ì…˜ ì œê±°
        .trim();
      
      if (cleanContent.length > 10) {
        // ì²« ë²ˆì§¸ ë¬¸ì¥ë§Œ (ë§ˆì¹¨í‘œ ê¸°ì¤€ìœ¼ë¡œ ë” ì—„ê²©í•˜ê²Œ)
        const sentences = cleanContent.split('.');
        const firstSentence = sentences[0]?.trim();
        
        if (firstSentence && firstSentence.length >= 10 && firstSentence.length <= 70) {
          return firstSentence;
        }
        
        // 60ìë¡œ ë” ì§§ê²Œ ìë¥´ê¸° (ë³¸ë¬¸ ë…¸ì¶œ ìµœì†Œí™”)
        return cleanContent.length > 60 ? cleanContent.substring(0, 60) + '...' : cleanContent;
      }
      
      return '';
    } catch (error) {
      console.warn('ìš”ì•½ ì¶”ì¶œ ì‹¤íŒ¨:', error);
      return '';
    }
  };

  // ë©”ì¸ ë¡œë”© ìƒíƒœ ì²˜ë¦¬ëŠ” DataStateHandlerë¡œ ì´ë™

  return (
      <div className="container mx-auto px-4 py-8">
        {/* Header */}
        <div className="text-center mb-12">
          <h1 className="text-4xl font-bold text-foreground mb-4">
            ğŸ­ ìš°ë¦¬í˜• ë©”ë¥´
          </h1>
          <p className="text-lg text-muted-foreground max-w-2xl mx-auto">
            ì¼ìƒ, íˆ¬ì, ë…ì„œ, ê·¸ë¦¬ê³  ì‚¶ì˜ ë‹¤ì–‘í•œ ì´ì•¼ê¸°ë“¤ì„ ë‚˜ëˆ„ëŠ” ê³µê°„ì…ë‹ˆë‹¤. 
            ë©”ë¥´ë§Œì˜ ë…íŠ¹í•œ ì‹œê°ìœ¼ë¡œ ì„¸ìƒì„ ë°”ë¼ë³¸ ì´ì•¼ê¸°ë“¤ì„ ë§Œë‚˜ë³´ì„¸ìš”.
          </p>
        </div>



      {/* í•„í„° ì„¹ì…˜ */}
      <div className="mb-8">
        <div className="flex items-center gap-4 p-4 bg-muted/50 border rounded-lg">
          <Filter size={20} className="text-muted-foreground" />
          <span className="text-sm font-medium text-foreground">í•„í„°:</span>
          
          <Select value={dateFilter} onValueChange={setDateFilter}>
            <SelectTrigger className="w-40">
              <SelectValue placeholder="ê¸°ê°„" />
            </SelectTrigger>
            <SelectContent>
              <SelectItem value="all">ì „ì²´ ê¸°ê°„</SelectItem>
              <SelectItem value="week">ìµœê·¼ 1ì£¼</SelectItem>
              <SelectItem value="month">ìµœê·¼ 1ê°œì›”</SelectItem>
              <SelectItem value="quarter">ìµœê·¼ 3ê°œì›”</SelectItem>
              <SelectItem value="year">ìµœê·¼ 1ë…„</SelectItem>
            </SelectContent>
          </Select>


          <Select value={tickerFilter} onValueChange={setTickerFilter}>
            <SelectTrigger className="w-48">
              <SelectValue placeholder="ì¢…ëª© ì„ íƒ" />
            </SelectTrigger>
            <SelectContent>
              <SelectItem value="all">ëª¨ë“  ì¢…ëª©</SelectItem>
              {availableStocks.map((stock) => (
                <SelectItem key={stock.ticker} value={stock.ticker}>
                  {stock.name} ({stock.ticker}) - {stock.count}ê°œ ì–¸ê¸‰
                </SelectItem>
              ))}
            </SelectContent>
          </Select>

          {(dateFilter !== 'all' || tickerFilter !== 'all') && (
            <Button 
              variant="ghost" 
              size="sm"
              onClick={() => {
                setDateFilter('all');
                setTickerFilter('all');
              }}
            >
              ì´ˆê¸°í™”
            </Button>
          )}
        </div>
      </div>

      {/* ë·° í† ê¸€ ë²„íŠ¼ */}
      <div className="flex items-center justify-between mb-6">
        <h2 className="text-2xl font-bold text-foreground">
          ğŸ“ ëª¨ë“  í¬ìŠ¤íŠ¸ 
          {totalPosts > 0 && (
            <span className="text-base font-normal text-muted-foreground ml-2">
              (ì´ {totalPosts}ê°œ)
            </span>
          )}
        </h2>
        
        {/* ë·° ëª¨ë“œ í† ê¸€ */}
        <div className="flex items-center gap-2">
          <Button
            variant={viewMode === 'card' ? 'default' : 'outline'}
            size="sm"
            onClick={() => setViewMode('card')}
            className="flex items-center gap-2"
          >
            <Grid3X3 size={16} />
            ì¹´ë“œ
          </Button>
          <Button
            variant={viewMode === 'list' ? 'default' : 'outline'}
            size="sm"
            onClick={() => setViewMode('list')}
            className="flex items-center gap-2"
          >
            <List size={16} />
            ë¦¬ìŠ¤íŠ¸
          </Button>
        </div>
      </div>

        <div className={viewMode === 'card' ? "grid gap-6 md:grid-cols-2 lg:grid-cols-3" : "space-y-4"}>
          {posts.map((post) => 
            viewMode === 'card' ? (
              // ì¹´ë“œ ë·°
              <Card key={post.id} className="group hover:shadow-lg transition-shadow">
                <CardHeader>
                  <CardTitle className="group-hover:text-blue-600 transition-colors">
                  <Link href={`/merry/posts/${post.id}`}>
                    {post.title}
                  </Link>
                </CardTitle>
              </CardHeader>
              <CardContent>
                {(() => {
                  // Claude ì§ì ‘ ë¶„ì„í•œ í•œì¤„ ìš”ì•½ ìš°ì„  ì‚¬ìš© (post_analysis í…Œì´ë¸”)
                  const claudeSummary = post.claudeSummary; // Claudeê°€ ë¶„ì„í•œ ê°œë³„ í¬ìŠ¤íŠ¸ í•œì¤„ ìš”ì•½
                  const fallbackSummary = extractMerrySummary(post.content); // ë³¸ë¬¸ì—ì„œ ì¶”ì¶œí•œ ìš”ì•½ (fallback)
                  const displaySummary = claudeSummary || fallbackSummary || post.content?.substring(0, 100) + '...';
                  
                  return (
                    <p className="text-muted-foreground mb-4 line-clamp-3">{displaySummary}</p>
                  );
                })()}
                
                <div className="flex flex-wrap gap-1 mb-4">
                  {(() => {
                    let tagsArray: string[] = [];
                    
                    try {
                      if (post.tags) {
                        if (typeof post.tags === 'string') {
                          // JSON ë¬¸ìì—´ íŒŒì‹± ì‹œë„
                          try {
                            const parsed = JSON.parse(post.tags);
                            if (Array.isArray(parsed)) {
                              tagsArray = parsed.filter(tag => typeof tag === 'string' && tag.trim().length > 0);
                            }
                          } catch (parseError) {
                            console.warn(`Failed to parse tags for post ${post.id}:`, parseError);
                            tagsArray = [];
                          }
                        } else if (Array.isArray(post.tags)) {
                          // ì´ë¯¸ ë°°ì—´ì¸ ê²½ìš°
                          tagsArray = post.tags.filter(tag => typeof tag === 'string' && tag.trim().length > 0);
                        }
                      }
                    } catch (error) {
                      console.error(`Tag processing error for post ${post.id}:`, error);
                      tagsArray = [];
                    }
                    
                    // ìµœì¢… ì•ˆì „ì„± ê²€ì¦
                    if (!Array.isArray(tagsArray)) {
                      tagsArray = [];
                    }
                    
                    return (
                      <>
                        {tagsArray.slice(0, 3).map((tag, index) => (
                          <Badge key={index} variant="outline" className="text-xs">
                            <Tag size={10} className="mr-1" />
                            {tag}
                          </Badge>
                        ))}
                        {tagsArray.length > 3 && (
                          <Badge variant="outline" className="text-xs">
                            +{tagsArray.length - 3}
                          </Badge>
                        )}
                        {tagsArray.length === 0 && (
                          <Badge variant="outline" className="text-xs text-muted-foreground">
                            íƒœê·¸ ì—†ìŒ
                          </Badge>
                        )}
                      </>
                    );
                  })()}
                </div>

                <div className="flex items-center gap-4 text-sm text-gray-500 mb-4">
                  <div className="flex items-center gap-1">
                    <User size={14} />
                    {post.author}
                  </div>
                  <div className="flex items-center gap-1">
                    <Calendar size={14} />
                    {formatDate(post.createdAt)}
                  </div>
                </div>

                <div className="flex items-center justify-between">
                  <div className="flex items-center gap-4 text-sm text-gray-500">
                    <div className="flex items-center gap-1">
                      <Eye size={14} />
                      {post.views}
                    </div>
                    <div className="flex items-center gap-1">
                      <Heart size={14} />
                      {post.likes}
                    </div>
                    <div className="flex items-center gap-1">
                      <MessageSquare size={14} />
                      {post.comments}
                    </div>
                  </div>
                  <Button variant="ghost" size="sm">
                    <Share2 size={14} />
                  </Button>
                </div>
              </CardContent>
            </Card>
            ) : (
              // ë¦¬ìŠ¤íŠ¸ ë·° (ì œëª©ê³¼ ë‚ ì§œë§Œ)
              <div key={post.id} className="flex items-center justify-between p-4 border rounded-lg hover:bg-muted/50 transition-colors">
                <div className="flex-1 min-w-0">
                  <Link href={`/merry/posts/${post.id}`} className="block">
                    <h3 className="font-medium text-foreground truncate hover:text-blue-600 transition-colors">
                      {post.title}
                    </h3>
                  </Link>
                </div>
                <div className="flex items-center gap-4 text-sm text-muted-foreground ml-4">
                  <div className="flex items-center gap-1">
                    <Calendar size={14} />
                    {new Date(post.createdAt).toLocaleDateString('ko-KR')}
                  </div>
                </div>
              </div>
            )
          )}
        </div>

        {/* ë”ë³´ê¸° ë²„íŠ¼ */}
        {hasMore && posts.length > 0 && (
          <div className="flex justify-center mt-8">
            <Button 
              onClick={loadMorePosts}
              disabled={loadMoreLoading.isLoading}
              size="lg"
              className="px-8"
            >
              {loadMoreLoading.isLoading ? (
                <>
                  <div className="animate-spin h-4 w-4 border-2 border-white border-t-transparent rounded-full mr-2"></div>
                  ë¡œë”© ì¤‘...
                </>
              ) : (
                'ë”ë³´ê¸° (10ê°œì”©)'
              )}
            </Button>
          </div>
        )}
        
        {/* ë”ë³´ê¸° ë¡œë”© ì—ëŸ¬ ì²˜ë¦¬ */}
        {loadMoreLoading.error && (
          <div className="flex justify-center mt-4">
            <div className="flex items-center space-x-2 text-destructive">
              <AlertCircle className="h-4 w-4" />
              <span className="text-sm">ë”ë³´ê¸° ì‹¤íŒ¨: {loadMoreLoading.error}</span>
              <Button 
                variant="ghost" 
                size="sm" 
                onClick={() => {
                  loadMoreLoading.retry();
                  loadMorePosts();
                }}
                className="text-xs"
              >
                ì¬ì‹œë„
              </Button>
            </div>
          </div>
        )}

        {/* í•„í„°ëœ ê²°ê³¼ ì—†ìŒ ì²˜ë¦¬ */}
        {posts.length === 0 && !mainLoading.isLoading && (dateFilter !== 'all' || tickerFilter !== 'all') && (
          <EmptyState
            message="ì„ íƒí•œ í•„í„°ì— í•´ë‹¹í•˜ëŠ” í¬ìŠ¤íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤"
            description="ë‹¤ë¥¸ í•„í„° ì¡°ê±´ì„ ì‚¬ìš©í•´ë³´ì„¸ìš”"
            icon={Filter}
            action={
              <Button 
                variant="outline"
                onClick={() => {
                  setDateFilter('all');
                  setTickerFilter('all');
                }}
              >
                í•„í„° ì´ˆê¸°í™”
              </Button>
            }
          />
        )}
      </div>
    </div>
  );
}